---
title: "TCGA analysis"
author:
- name: Romana Pop
  affiliation: Centre for Molecular Medicine Norway
  email: romanatp@uio.no
package: MARMOT
output:
  BiocStyle::html_document
abstract: |
  Description of your vignette
vignette: |
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

##########################################
# notes to self
* the methylation in ovarian cancer has "-" as separators in the sample IDs
* changed it manually for now, but maybe make some code at some point to go through all the data and make sure the samples names are the same.
* for some reason, feature names seem not to be a thing when loading the data and creating the omic list. Gotta look into that too
###########################################

# Introduction

Some text. 

# Loading libraries and data
```{r loading_libraries}
rm(list=ls())
# load libraries
library(devtools)
devtools::load_all("/storage/kuijjerarea/romana/TCGAmofa/MOFAnet/")
library(tidyverse)
library(preprocessCore)
library(RColorBrewer)
library(msigdbr)
library(gridExtra)
```

# Preparing data
```{r params}
# setting working directory
wd <- "/storage/kuijjerarea/romana/TCGAmofa/june_2024_run"
#wd <- "/storage/kuijjerarea/romana/TCGAmofa/june_2024_run/gep_liver"
setwd(wd)

# specify data directory
data_dir <- "/storage/kuijjerarea/romana/TCGAmofa/cantini_benchmark/momix-notebook/data/cancer/"
#data_dir <- "/storage/kuijjerarea/romana/TCGAmofa/june_2024_run/liver_val_old/"

# specify directory with clinical data
clin_dir <- "/storage/kuijjerarea/romana/TCGAmofa/cantini_benchmark/momix-notebook/data/clinical/"
#clin_dir <- data_dir

# defining vector of cancer names for which to do the analysis
cancers <- c("aml", "breast", "colon", "gbm", "kidney", "liver", "lung",
          "melanoma", "ovarian", "sarcoma")
#cancers <- "liver"

model <- c("nonet", "indeg", "out", "both")

# define vector of omic names that will be used
omic_names <- c("expression", "methylation", "miRNA", "indegree", "outdegree")
#omic_names <- c("expression", "indegree", "outdegree")
```
```{r prepare_data}
# prepare data for JDR
for (cancer in cancers) {
    print(cancer)
    # get omic file names
    #files <- c(paste0(rep(paste0(data_dir, cancer, "/"), 5),
     #          c("log_exp", "methy", "log_mirna",
      #         "indegree_quant.RData", "outdegree.RData")))
    files <- c(paste0(rep(paste0(data_dir, "/"), 3),
               c("exp_log.txt", "indegree_quant.RData", "outdegree.RData")))

    # normalise indegrees
    if (!file.exists(files[4])) {
        #load(paste0(data_dir, cancer, "/indegree.RData"))
        load(paste0(data_dir, "/indegree.RData"))
        indegree <- normalize.quantiles(as.matrix(indegree), copy = FALSE)
        #save(indegree, file = paste0(data_dir, cancer, "/indegree_quant.RData"))
        save(indegree, file = paste0(data_dir, "/indegree_quant.RData"))

    }

    # without PCA
    omics <- prepare_data(omics = files, names = omic_names, pca = FALSE,
                         logs = TRUE,
                         log_name = "logs/prep_data_no_pca_log.txt")
    save(omics, file = paste0(wd, "/", cancer, "_omics_no_pca.Rda"))

    # with PCA
    omics <- prepare_data(omics = files, names = omic_names, pca = TRUE,
                         logs = TRUE, log_name = "logs/prep_data_pca_log.txt",
                         file_name = paste0(cancer, "_omics_pca_results.Rda"))
    save(omics, file = paste0(wd, "/", cancer, "_omics_pca.Rda"))
}
```

```{r prepare_surv}
for (cancer in cancers) {
  print(cancer)
  clin <- paste0(clin_dir, cancer)
  
  # kidney just gotta be special
  if (cancer == "kidney") {
    surv <- prepare_surv(clinical = clin, feature_names = list(sample_id = "submitter_id.samples", 
                                              vital_status = "vital_status.diagnoses",
                                              time_to_event = c("days_to_death.diagnoses",
                                                                "days_to_last_follow_up.diagnoses")))
    surv$sample_id <- str_sub(surv$sample_id, end = -2)
  } else {
    #surv <- prepare_surv(clinical = clin, feature_names = list(sample_id = "sampleID", 
     #                                         vital_status = "vital_status",
      #                                        time_to_event = c("days_to_death", "days_to_last_followup")))
    surv <- prepare_surv(clinical = clin, feature_names = list(sample_id = "Run",
                                             vital_status = "OS.event",
                                             time_to_event = c("OS")))  
  }

  surv$sample_id <- gsub("-", "\\.", surv$sample_id)
  save(surv, file = paste0(wd, "/", cancer, "_surv.Rda"))
}
```

# PCA vs no PCA comparison with multiple JDR tools

```{r bench_no_pca}
for (cancer in cancers) {
    print(cancer)
    # for now I'm gonna do it with cantini's code until I figure
    # out the finer details for my own code
    #source("/storage/kuijjerarea/romana/TCGAmofa/cantini_benchmark/momix-notebook/scripts/runfactorization.R")

    # load data
    load(paste0(wd, "/", cancer, "_omics_no_pca.Rda"))

    #factorizations <- runfactorization(omics=omics,num.factors = 5, sep = sep)
    factorizations <- run_jdr(omic_list = omics, seed = 13, jdr_methods = "JIVE")

    save(factorizations, file = paste0(wd, "/benchmark", cancer, "_JIVE_test_no_PCA.Rda"))
    
    #save(factorizations, file = paste0(wd, "/benchmark/", cancer, "_factorisation_no_PCA_5fct.Rda"))

    # run the factorisation with all tools without PCA
    #fct_list <- run_factorisations(omic_list = omics, pca = FALSE, seed = 13)

    #save(fct_list, file = paste0("benchmark/", cancer,
    #     "_JDR_models_no_pca.Rda"))
}
```

```{r bench_pca}
for (cancer in cancers) {
     # for now I'm gonna do it with cantini's code until I figure
    # out the finer details for my own code
    source("/storage/kuijjerarea/romana/TCGAmofa/cantini_benchmark/momix-notebook/scripts/runfactorization.R")

    # load data
    load(paste0(wd, "/", cancer, "_omics_pca.Rda"))

    #factorizations <- runfactorization(omics=omics,num.factors = 5, sep = sep)
    factorizations <- run_jdr(omic_list = omics, seed = 13)
    save(factorizations, file = paste0(wd, "/benchmark/", cancer, "_factorisation_PCA_5fct.Rda"))
  
    # run the factorisation with all tools without PCA
  #  model_list <- run_factorisations(omic_list = omics, pca = FALSE, seed = 13)

   # save(model_list, file = paste0("benchmark/", cancer,
   #      "_JDR_models_pca.Rda"))

    # extract the factors
  #  for (model in seq_along(model_list)) {
  #      tool <- names(model_list)[model]
  #  }
}
```

# PCA vs no PCA comparison of data dimensions and distributions

```{r r2_cum variations}
r2cum <- c(0.8, 0.85, 0.9, 0.95)

for (cancer in cancers) {

  files <- c(paste0(rep(paste0(data_dir, cancer, "/"), 5),
               c("log_exp", "methy", "log_mirna",
               "indegree_quant.RData", "outdegree.RData")))

  for (j in r2cum) {
    # with PCA  # with PCA
      omics <- prepare_data(omics = files, names = omic_names, pca = TRUE,
                          logs = TRUE, log_name = "logs/prep_data_pca_log.txt",
                          file_name = paste0(cancer, "_omics_pca_results_", j, ".Rda"))
      save(omics, file = paste0(wd, "/", cancer, "_omics_pca_", j, ".Rda"))
      omics <- prepare_data(omics = files, names = omic_names, pca = TRUE,
                          logs = TRUE, log_name = "logs/prep_data_pca_log.txt",
                          file_name = paste0(cancer, "_omics_pca_results_", j, ".Rda"))
      save(omics, file = paste0(wd, "/", cancer, "_omics_pca_", j, ".Rda"))
  }
}
```

```{r pca_vs_nopca_data_dim}
p_list <- list()
for (cancer in cancers) {
  data <- c(paste0(wd, "/", cancer, "_omics_no_pca.Rda"),
            paste0(wd, "/", cancer, "_omics_pca.Rda"))
  # plot bar plots
  p <- plot_data_dim(data = data[2], data_labels = c("PCA"),
                      log_x = FALSE, title = cancer, compare = FALSE)
  ggsave(p, file = paste0("figures/", cancer, "_data_dim_pca.pdf"),
        height = 11, width = 11)

  p_list[[cancer]] <- p
}

grid_plot <- grid.arrange(grobs = p_list, ncol = 3)
ggsave(grid_plot, file = "figures/data_dim_compare_all_can.pdf", height = 35, width = 35)
```

```{r pca_vs_no_pca_data_distr}
p_list <- list()
for (cancer in cancers) {
  pca <- get(load(paste0(cancer, "_omics_pca.Rda")))
  no_pca <- get(load(paste0(cancer, "_omics_no_pca.Rda")))

  plot <- plot_data_distributions(pca, no_pca, labels = c("PCA", "no PCA"),
                                  title = cancer)
  #ggsave(plot, file = paste0("figures/", cancer, "_data_distribution_comparison.pdf"))

  p_list[[cancer]] <- plot
}

grid_plot <- grid.arrange(grobs = p_list, ncol = 3)
ggsave(grid_plot, file = "figures/data_dis_compare_all_can.pdf", height = 20, width = 20)
```

# surv analysis for all cancers

```{r surv_assoc_bench}
# with old code for now
#run survival for each cancer for each method
surv_df <- data.frame()
for(i in cancers){
  PCA <- get(load(paste0(wd, "/benchmark/", i,"_factorisation_PCA_5fct.Rda")))
  noPCA <- get(load(paste0(wd, "/benchmark/", i,"_factorisation_no_PCA_5fct.Rda")))
  surv <- get(load(paste0(wd, "/", i, "_surv.Rda"))) # again, this requires the MOFA analysis to have been run first, but for now it works
  
  #names(PCA$factorizations) <- PCA$method
  #names(noPCA$factorizations) <- noPCA$method
  
  #if(is.null(methods)){
    methods <- names(PCA)
  #}
  
  for(j in methods){
    if(j =="MOFA"){
      #get the factorisations for that method
      pca_fct <- PCA[[j]][[1]]
      nopca_fct <- noPCA[[j]][[1]]
    }else{
      #get the factorisations for that method
      pca_fct <- PCA[[j]]
      nopca_fct <- noPCA[[j]]
    }
    
    #run the surv association of the factors
    PCA_cox <- surv_association(pca_fct, surv, univariate = TRUE)
    noPCA_cox <- surv_association(nopca_fct, surv, univariate = TRUE)
    
    df <- surv_compare(models = list(PCA_cox, noPCA_cox), 
                       model_labels = c("PCA", "no_PCA"), univariate = TRUE, 
                      method = "BH")
    
    df$cancer <- i
    df$method <- j
    
    surv_df <- rbind(surv_df, df)
    
    cox_all <- list(PCA_cox, noPCA_cox)
    names(cox_all) <- c("PCA", "no_PCA")
    
    save(cox_all, file=paste0(i,"_cox_models_", j,"_5fct.Rda"))
  }
}
save(surv_df, file=paste0(wd, "/benchmark/TCGA_surv_all_bench_5fct.Rda"))

# extract the factors

```

```{r surv_compare_bench}
load("benchmark/TCGA_surv_all_bench_5fct.Rda")

method <- unique(surv_df$method)
cols <- palette("Dark2")

for(i in method){
  surv_meth <- surv_df[which(surv_df$method == i),]
  models <- unique(surv_meth$label)
  p <- surv_compare_dotplot(surv_df = surv_meth, models_to_compare = models,
                            colours = c(cols[8], "grey", cols[6]))
  
  ggsave(p, file=paste0(wd,"/figures/surv_compare_PCA_",i,"_5fct.png"))
  ggsave(p, file=paste0(wd,"/figures/surv_compare_PCA_",i,"_5fct.pdf"))
}
```

# MOFA analysis begins

```{r mofa_models}
for (cancer in cancers) {
  load(paste0(wd, "/", cancer, "_omics_pca.Rda"))

  #nonet
  #data_nonet <- omics[1:3]
  data_nonet <- omics[1]
  mofa_nonet <- run_mofa2(data_nonet, n_fct = 5, seed = 13, convergence = "slow", use_basilisk = T)
  save(mofa_nonet, file = paste0("MOFA_", cancer, "_pca_nonet.Rda"))

  # with indeg
  #data_indeg <- omics[-5] #tcga
  data_indeg <- omics[-3]
  mofa_indeg <- run_mofa2(data_indeg, n_fct = 5, seed = 13, convergence = "slow", use_basilisk = T)
  save(mofa_indeg, file = paste0("MOFA_", cancer, "_pca_indeg.Rda"))
  
  # with outdeg
  #data_out <- omics[-4]
  data_out <- omics[-2]
  mofa_out <- run_mofa2(data_out, n_fct = 5, seed = 13, convergence = "slow", use_basilisk = T)
  save(mofa_out, file = paste0("MOFA_", cancer, "_pca_out.Rda"))
  
  # with both
  data_both <- omics
  mofa_both <- run_mofa2(data_both, n_fct = 5, seed = 13, convergence = "slow", use_basilisk = T)
  save(mofa_both, file = paste0("MOFA_", cancer, "_pca_both.Rda"))

  # without exp
  data_noexp <- omics[-1]
  mofa_noexp <- run_mofa2(data_noexp, n_fct = 5, seed = 13, convergence = "slow", use_basilisk = T)
  save(mofa_noexp, file = paste0("MOFA_", cancer, "_pca_no_exp.Rda"))

  # without methy
  #data_nometh <- omics[-2]
  #mofa_nometh <- run_mofa2(data_nometh, n_fct = 5, seed = 13, convergence = "slow", use_basilisk = T)
  #save(mofa_noexp, file = paste0("MOFA_", cancer, "_pca_no_methy.Rda"))

  # without mirna
  #data_nomir <- omics[-3]
  #mofa_nomir<- run_mofa2(data_nomir, n_fct = 5, seed = 13, convergence = "slow", use_basilisk = T)
  #save(mofa_noexp, file = paste0("MOFA_", cancer, "_pca_no_mir.Rda"))
}
```

```{r fct_corr}
corr_all <- list()
corr_df <- data.frame()

for (i in cancers) {
  # load models
  all <- get(load(paste0("MOFA_", i, "_pca_both.Rda")))
  nonet <- get(load(paste0("MOFA_", i, "_pca_nonet.Rda")))

  # get factors
  all_fct <- get_factors(all)[[1]]
  nonet_fct <- get_factors(nonet)[[1]]

  corr <- fct_corr(all_fct, nonet_fct, labels = c("all", "no GRN"),
                    as_data_frame = TRUE, abs = TRUE)
  corr_all[[i]] <- corr

  # reformat as data frame
  df <- format_fct_corr(corr)
  df$cancer <- i

  # plot
  p <- plot_fct_corr(df, abs = TRUE)

  # removing facet headers for individual plots
  p <- p + 
  theme(strip.background = element_blank(),  # Remove background of the facet label
        strip.text = element_blank())

  ggsave(p, file = paste0("figures/", i, "_view_exclusion_both_abs.pdf"), width = 10, height = 9)

  corr_df <- rbind(corr_df, df)
}

save(corr_df, file = "view_exclusion_corr_df_both_abs.Rda")
save(corr_all, file = "view_exclusion_corr_both_abs.Rda")

q <- plot_fct_corr(corr_df)
q <- q + theme(legend.position = c(0.65, 0.1),
              legend.key.size = unit(1.5, "cm"))
ggsave(q, file = paste0("figures/view_exclusion_heat_both_abs.pdf"),
       height = 16, width = 18)
ggsave(q, file = paste0("figures/view_exclusion_heat_both_abs.png"),
       height = 10, width = 10)
```

```{r var_explained_heat}
cols <- palette("Dark2")
load("TCGA_MOFA_surv_df_all_PCA_quant_new.Rda")

for (cancer in cancers) {
  surv_can <- surv_df %>%
              filter(cancer == cancer)
  load(paste0("MOFA_", cancer, "_pca_nonet.Rda"))
  load(paste0("MOFA_", cancer, "_pca_indeg.Rda"))
  load(paste0("MOFA_", cancer, "_pca_out.Rda"))
  load(paste0("MOFA_", cancer, "_pca_both.Rda"))

  n <- suppressMessages(plot_var_heat(mofa_nonet))
  #n + title(main = "no net")
  ggsave(n, file = paste0("figures/",cancer, "_var_explained_no_net.pdf"))


  i <- suppressMessages(plot_var_heat(mofa_indeg))
  #i + title(main = "indegree")
  ggsave(i, file = paste0("figures/",cancer, "_var_explained_indeg.pdf"))

 
  o <- suppressMessages(plot_var_heat(mofa_out))
 # o + title(main = "outdegree")
   ggsave(o, file = paste0("figures/", cancer, "_var_explained_out.pdf"))

  
  b <- suppressMessages(plot_var_heat(mofa_both))
 # b + title(main = "both")
  ggsave(b, file = paste0("figures/",cancer, "_var_explained_both.pdf"))

}

```

```{r surv_assoc}
# old code
surv_df <- data.frame()
for (i in cancers) {
  # load mofa models
  nonet <- get(load(paste0("MOFA_", i, "_pca_nonet.Rda")))
  deg <- get(load(paste0("MOFA_", i, "_pca_indeg.Rda")))
  out <- get(load(paste0("MOFA_", i, "_pca_out.Rda")))
  both <- get(load(paste0("MOFA_", i, "_pca_both.Rda")))
  
  # get surv data
  if(file.exists(paste0(i,"_surv.Rda"))){ #just for the 10fct thing. make sure to get rid of the "../" later
    load(paste0(i, "_surv.Rda"))
  }else{
    surv <- prepare_surv(clinical = paste0(clin_dir,i),
                         feature_names = list(sample_id = "sampleID", 
                                              vital_status = "vital_status",
                                              time_to_event = c("days_to_death", "days_to_last_followup")))
    surv$sample_id <- gsub("-", "\\.", surv$sample_id)
    
    
   save(surv, file=paste0(i,"_surv.Rda"))
  }

  # doing this for colon cancer because for some reason, my approach really screwed up and I lost a lot of samples
  # have to figure out why
  # all the other cancers got their surv processed with the above code
  #surv <- read.table(paste0(data_dir, i, "/survival"), sep = "\t", head = TRUE)
  #colnames(surv) <- c("sample_id", "time_to_event", "vital_status")
  #surv$sample_id <- gsub("-", "\\.", surv$sample_id)
  #surv$sample_id <- toupper(surv$sample_id)
  
  # getting factors
  nonet_fct <- get_factors(nonet)[[1]]
  deg_fct <- get_factors(deg)[[1]]
  out_fct <- get_factors(out)[[1]]
  both_fct <- get_factors(both)[[1]]
  
  # survival association
  # cox <- calculate_surv_association(nonet_fct, surv, by_factor = by_factor)
  # cox_d <- calculate_surv_association(deg_fct, surv, by_factor = by_factor)
  # cox_o <- calculate_surv_association(out_fct, surv, by_factor = by_factor)
  # cox_b <- calculate_surv_association(both_fct, surv, by_factor = by_factor)
  
  cox <- surv_association(nonet_fct, surv, univariate = TRUE)
  cox_d <- surv_association(deg_fct, surv, univariate = TRUE)
  cox_o <- surv_association(out_fct, surv, univariate = TRUE)
  cox_b <- surv_association(both_fct, surv, univariate = TRUE)
  
  # df <- surv_compare(models = list(cox, cox_d, cox_o, cox_b), 
  #                    model_labels = model, by_factor = by_factor, 
  #                    logtrans = logtrans, p_adjust = p_adjust, method = method)
  
  df <- surv_compare(models = list(cox, cox_d, cox_o, cox_b), 
                     model_labels = model, univariate = TRUE, 
                     method = method)
  
  df$cancer <- i
  
  surv_df <- rbind(surv_df, df)
  
  cox_all <- list(cox, cox_d, cox_o, cox_b)
  names(cox_all) <- c("nonet", "indeg", "out", "both")
  
  save(cox_all, file=paste0(i,"_cox_models_PCA_quant_new.Rda"))
  
  
}

save(surv_df, file=paste0("TCGA_MOFA_surv_df_all_PCA_quant_new.Rda")) 
```

```{r surv_sig_heat}
load("TCGA_MOFA_surv_df_all_PCA_quant_new.Rda")
cols <- palette("Dark2")

for (can in cancers) {
  surv_can <- surv_df %>%
              filter(cancer == can) %>%
              select(c(label, factor, logp, cancer)) %>%
              filter(label %in% c("both", "nonet")) 

  p <- .plot_heatmap(surv_can)
  p <- p + 
       scale_fill_gradient(low = "white", high = cols[1],
                           limits = c(0,3),
                           breaks = seq(0,3, by = 1)) +
       labs(x = "Model", y = NULL, fill = expression("-log"[10] * "FDR"))
  ggsave(p, file = paste0("figures/", can, "_fct_sig_heat.pdf"))
}
```

```{r surv_compare_plots}
# generate comparison plots
if(!exists("surv_df")){
  load(paste0("TCGA_MOFA_surv_df_all_PCA_quant_new.Rda"))
}

#get models to compare
model_comp <- setdiff(model, "nonet")

#set colours
cols <- palette("Dark2")

for(i in model_comp){
  models_to_compare <- c("nonet", i)
  p <- surv_compare_dotplot(surv_df = surv_df, models_to_compare = models_to_compare, 
                            colours = c(cols[8], "grey", cols[1]))
  
  ggsave(p, file=paste0(wd, "/figures/surv_compare_",models_to_compare[2],"_bee_5_PCA_quant.png"))
  ggsave(p, file=paste0(wd, "/figures/surv_compare_",models_to_compare[2],"_bee_5_PCA_quant.pdf"))
}
```

# liver analysis

```{r clin_association_liver}
clin <- read.table(paste0(clin_dir, "liver"), head = TRUE, sep = "\t")
clin$sampleID <- gsub("-", "\\.", clin$sampleID)

# get mofa model
#MOFAmodel <- get(load(paste0("MOFA_liver_pca_indeg_quant.Rda")))
MOFAmodel <- get(load(paste0("gep_liver/MOFA_liver_pca_both.Rda")))


# make sure samples are the same
clin_fil <- clin[clin[, 1] %in% samples_metadata(MOFAmodel)$sample, ]
colnames(clin_fil)[1] <- "sample"

#make sure missing values are NAs
clin_fil <- mutate_all(clin_fil, ~ ifelse(. == "", NA, .))

# extract factors
Z <- as.data.frame(get_factors(MOFAmodel)[[1]])
feat <- c("Phenotype", "Age", "Sex", "Fibrosis", "Tumor.stage", "Tumor.size")
#feat <- c("additional_pharmaceutical_therapy", "additional_radiation_therapy", 
 #        "age_at_initial_pathologic_diagnosis", "histological_type", "pathologic_stage",
  #       "gender", "fibrosis_ishak_score")
association <- clin_associaton(Z, clin = clin_fil, clin_feat = feat, sample_label = "sample")

save(association, file = paste0("gep_liver/liver_clin_feat_ass_both.Rda"))

# plot clin association
load("gep_liver/liver_clin_feat_ass_both.Rda")
pdf(file = "gep_liver/figures/liver_clin_ass_both_values.pdf", width = 10, height = 10)
p <- plot_clin_association(association)
print(p)
dev.off()
```

# differential indegree analysis
```{r deal_with_age_in_gep_data}
# taking median of age interval for gep liver clinical data
clin <- read.table(paste0(clin_dir, "liver"), sep = "\t", head = TRUE)
age <- clin$Age
age_med <- sapply(age, convert_interval_to_median)
clin$Age <- age_med

write.table(clin, file = paste0(clin_dir, "liver_med_age"), sep = "\t")
```


```{r diff_indeg_liver}
# load data
indeg <- get(load("liver_omics_no_pca.Rda"))[["indegree"]]
clin <- read.table(paste0(clin_dir, "liver"), sep = "\t", head = TRUE)
colnames(clin)[1] <- "sample_id"
clin$sample_id <- gsub("-", "\\.", clin$sample_id)
load("liver_surv.Rda")
load("TCGA_MOFA_surv_df_all_PCA_quant.Rda")
load("MOFA_liver_pca_both.Rda")
minprops <- c(0.1, 0.2, 0.3, 0.4, 0.5)
#use_median <- TRUE

# get significant factors
sig <- surv_df %>% filter(cancer == "liver", label == "both", padj <= 0.05)
Z <- get_factors(mofa_both)[[1]]
Z <- as.data.frame(Z[, sig$factor])

# run with limma and no covariate correction

# Create the  file names
base_names <- paste0("diff_indeg_liver_limma_", colnames(Z))

# Apply differential_analysis to each column of Z with corresponding file name
#diff <- Map(function(x, file_name) {
#  factor <- setNames(x, rownames(Z))
#  differential_analysis(omic = indeg, factor = factor, surv = surv, clin = clin,
#  file_name = file_name, covariates = c("age_at_initial_pathologic_diagnosis",
#                                        "gender"), sample_label = "sample_id")
#}, Z, file_names)

#diff <- Map(function(x, file_name) {
#  factor <- setNames(x, rownames(Z))
#  differential_analysis(omic = indeg, factor = factor, surv = surv,
#  file_name = file_name, sample_label = "sample_id", use_median = use_median)
#}, Z, base_names)

# trying this with varying minprop
#diff <- Map(function(x, base_name) {
 # Map(function(mp) {
  #  factor <- setNames(x, rownames(Z))
   # file_name <- paste0(base_name, "_minprop_", mp, ".Rda")
    #differential_analysis(omic = indeg, factor = factor, surv = surv, clin = clin,
     # file_name = file_name, covariates = c("age_at_initial_pathologic_diagnosis", "gender"),
      #sample_label = "sample_id", minprop = mp)
  #}, minprops)
#}, Z, base_names)

# for gep
diff <- Map(function(x, base_name) {
  mps <- Map(function(mp) {
    factor <- setNames(x, rownames(Z))
    file_name <- paste0(base_name, "_minprop_", mp, ".Rda")
    differential_analysis(omic = indeg, factor = factor, surv = surv,
      file_name = file_name,
      sample_label = "sample_id", minprop = mp)
  }, minprops)
  names(mps) <- paste0("minprop_", minprops)
  return(mps)
}, Z, base_names)

save(diff, file = "diff_indeg_liver_limma_all_fct.Rda")
```

```{r diff_indeg_liver_gsea}
load("diff_indeg_liver_limma_all_fct.Rda")
minprops <- c(0.1, 0.2, 0.3, 0.4, 0.5)

# get pathways
hallmark <- msigdbr(species = "human", category = "H")
hallmark <- as.data.frame(cbind(hallmark$gs_name,hallmark$human_gene_symbol))
colnames(hallmark) <- c("gs_name", "human_gene_symbol")
#react <- msigdbr(species = "human", category = "C2", subcategory = "CP:REACTOME")
#react <- as.data.frame(cbind(react$gs_name, react$human_gene_symbol))
#colnames(react) <- c("gs_name", "human_gene_symbol")

# make pathway names lowercase
hallmark$gs_name <- tolower(hallmark$gs_name)
#react$gs_name <- tolower(react$gs_name)

# remove the "hallmark" before every path name
hallmark$gs_name <- gsub("hallmark_","",hallmark$gs_name)
#react$gs_name <- gsub("reactome_","",react$gs_name)

hallmark <- split(hallmark$human_gene_symbol, hallmark$gs_name)
#react <- split(react$human_gene_symbol, react$gs_name)

base_names <- paste0(rep("liver_gsea_diff_indeg_", length(diff)), names(diff))

# run gsea
#gsea_res <- Map(function(x, file_name) {
#  perform_gsea(diff_results = x, gene_set = hallmark, file_name = file_name,
#  limma = TRUE)}, diff, base_names)

# trying with minprop variation
gsea_res <- Map(function(diff_sublist, base_name) {
  Map(function(x, mp) {
    file_name <- paste0(base_name, "_minprop_", mp, ".Rda")
    perform_gsea(diff_results = x, gene_set = hallmark, file_name = file_name, limma = TRUE)
  }, diff_sublist, minprops)
}, diff, base_names)

save(gsea_res, file = "liver_gsea_diff_all_fct.Rda")
```

```{r path_select}
load("liver_gsea_diff_all_fct_minprop_var.Rda")

# select only pathways that are enriched across all 3 minprops
stable_path <- Map(function(res) {
  select_stable_path(res, thresh = 0.05)
  #stable <- lapply(stable, function(x) x[[1]])
  #return(stable)
}, gsea_res)


save(stable_path, file = "gsea_stable_path_across_minprop.Rda")
```

```{r plot_diff_gsea_results}
load("liver_gsea_diff_all_fct.Rda")

gsea_res <- lapply(gsea_res, function(x) x[[5]]) # if you wanna pick a specific minprop
file_name <- "figures/gsea_path_hallmark_minprop_0.5.pdf"

#get stable pathways across minprop
#stable_path <- lapply(stable_path, function(x) x[[1]])

# Add the factor column to each data frame and merge them
#factors <- names(stable_path)
factors <- names(gsea_res)
merged_df <- bind_rows(Map(function(df, factor) {
  df %>% mutate(factor = factor)
}, gsea_res, factors))

plot <- gsea_dotplots(merged_df, surv_df = surv_df, gene_set = "hallmark",
                      title = "TCGA", file_name = file_name, n_path = NULL,
                      thresh = 1.30103, width = 30, height = 30, limitsize = FALSE)

#ggsave(plot, file = file_name)

#plots <- Map(function(x, title, file_name, ...) {
 # gsea_dotplots(gsea_results = x, surv_df = surv_df, gene_set = "reactome",
  #title = title, file_name = file_name, n_path = NULL, thresh = 1.30103,
  #width = 160, height = 180, limitsize = FALSE)
#}, gsea_subset, titles, file_names)
```

```{r plot_KM_plots}
load("liver_surv.Rda")
load("MOFA_liver_pca_both.Rda")
load("TCGA_MOFA_surv_df_all_PCA_quant.Rda")

minprops <- c(0.1, 0.2, 0.3)
use_median <- TRUE

sig <- surv_df %>% filter(cancer == "liver", label == "both", padj <= 0.05)
Z <- get_factors(mofa_both)[[1]]
Z <- as.data.frame(Z[, sig$factor])

# plot km
titles <- colnames(Z)

plots <- Map(function(factor, title) {
  factor <- setNames(factor, rownames(Z))
  surv_factor_km(surv = surv, factor = factor, title = title, minprops = minprops,
                use_median = use_median)
  #ggsave(km, file = file_name)
}, Z, titles)

grid_plot <- grid.arrange(grobs = plots, ncol = 3)
ggsave(grid_plot, file = "figures/km_grid_all_fct_med.pdf", width = 27, height = 10)

c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E", "#E6AB02", "#A6761D","gray40")
#c("#1B9E77", "#D95F02", "#67BEA4", "#E59456", "#B3DED1", "#F2C9AA")

```

```{r km_plots_with_median}

```

# outdegree analysis

```{r features_mapping_liver}
# load data
out <- get(load("liver_omics_no_pca.Rda"))[["outdegree"]]
load("MOFA_liver_pca_both.Rda")
load("liver_omics_pca_results.Rda")

# get MOFA weights
mofa_weights <- get_weights(mofa_both)

mapped_wts <- Map(function(x, pca_wts) {
  map_wts(fct_weights = x, pca_weights = pca_wts)
}, mofa_weights, omics_pca)

save(mapped_wts, file = "liver_mapped_feat_wts_test.Rda")
```

```{r plot_feature_weights}
load("liver_mapped_feat_wts.Rda")

factors <- c("Factor2")
file_names <- paste0(rep("figures/liver_feat_wts_", length(omic_names)), omic_names, "_", factors, "_thresh_test.pdf")

plots <- Map(function(feat, title, file_name, ...) {
  plot_feat_wts(feat_wts = feat, fct = factors, file_name = file_name, thresh = 0.5,
  plot_distribution = FALSE, width = 7, height = 10, limitsize = FALSE)
}, mapped_wts, omic_names, file_names)

```

```{r diff_out_liver}
# load data
indeg <- get(load("liver_omics_no_pca.Rda"))[["outdegree"]]
clin <- read.table(paste0(clin_dir, "liver"), sep = "\t", head = TRUE)
colnames(clin)[1] <- "sample_id"
clin$sample_id <- gsub("-", "\\.", clin$sample_id)
load("liver_surv.Rda")
load("TCGA_MOFA_surv_df_all_PCA_quant.Rda")
load("MOFA_liver_pca_both.Rda")
minprops <- c(0.1, 0.2, 0.3)

# get significant factors
sig <- surv_df %>% filter(cancer == "liver", label == "both", padj <= 0.05)
Z <- get_factors(mofa_both)[[1]]
Z <- as.data.frame(Z[, sig$factor])

# run with limma and no covariate correction

# Create the  file names
base_names <- paste0("diff_out_liver_limma_", colnames(Z))

# Apply differential_analysis to each column of Z with corresponding file name
#diff <- Map(function(x, file_name) {
#  factor <- setNames(x, rownames(Z))
#  differential_analysis(omic = indeg, factor = factor, surv = surv, clin = clin,
#  file_name = file_name, covariates = c("age_at_initial_pathologic_diagnosis",
#                                        "gender"), sample_label = "sample_id")
#}, Z, file_names)

#diff <- Map(function(x, file_name) {
#  factor <- setNames(x, rownames(Z))
#  differential_analysis(omic = indeg, factor = factor, surv = surv,
#  file_name = file_name, sample_label = "sample_id")
#}, Z, file_names)

# trying this with varying minprop
diff <- Map(function(x, base_name) {
  Map(function(mp) {
    factor <- setNames(x, rownames(Z))
    file_name <- paste0(base_name, "_minprop_", mp, ".Rda")
    differential_analysis(omic = indeg, factor = factor, surv = surv, clin = clin,
      file_name = file_name, covariates = c("age_at_initial_pathologic_diagnosis", "gender"),
      sample_label = "sample_id", minprop = mp)
  }, minprops)
}, Z, base_names)

save(diff, file = "diff_out_liver_limma_all_fct_minprop_var.Rda")
```

```{r out_volcano_plots}
load("diff_out_liver_limma_all_fct_minprop_var.Rda")

p <- volcano_plot(diff[[1]][[3]], labels = TRUE)

ggsave(p, file = "figures/volcano_test.pdf")

```

```{r corr_fct_tcga_gep}


```

```{r overlap_top_TFs_TCGA_GEP}
# load data
gep <- get(load("gep_liver/liver_mapped_feat_wts.Rda"))[["outdegree"]]
tcga <- get(load("liver_mapped_feat_wts.Rda"))[["outdegree"]]

# factor names
gep_fct <- c("Factor2", "Factor3", "Factor4")
tcga_fct <- c("Factor2", "Factor4", "Factor5")

# melt
gep <- reshape2::melt(gep)
tcga <- reshape2::melt(tcga)
colnames(gep) <- c("feature", "factor", "value")
colnames(tcga) <- c("feature", "factor", "value")

# all tfs
tfs <- unique(gep$feature)

# filter & sort by weight
gep <- gep %>%
      filter(factor %in% gep_fct)

tcga <- tcga %>%
      filter(factor %in% tcga_fct)

# scale
gep <- gep %>%
        group_by(factor) %>%
        mutate(value = value / max(abs(value), na.rm = TRUE)) %>%
        slice_max(order_by = abs(value), n = 10) %>%
        #filter(value > 0.5) %>%
        ungroup()

tcga <- tcga %>%
        group_by(factor) %>%
        mutate(value = value / max(abs(value), na.rm = TRUE)) %>%
        slice_max(order_by = abs(value), n = 10) %>%
        #filter(value > 0.5) %>%
        ungroup()

# create contingency table for fisher's exact test
common <- length(unique(intersect(tcga$feature, gep$feature)))
in_gep <- length(unique(gep$feature)) - common
in_tcga <- length(unique(tcga$feature)) - common
in_neither <- length(tfs) - (in_gep + in_tcga + common)

contingency_table <- matrix(c(common, in_gep, in_tcga, in_neither), nrow = 2, byrow = TRUE)

# perform fisher test
fisher_result <- fisher.test(contingency_table)

save(fisher_result, file = "outdeg_gep_tcga_fisher_result_top10.Rda")
```

```{r plot_common_TFs}
# load data
gep <- get(load("liver_mapped_feat_wts.Rda"))[["outdegree"]]
tcga <- get(load("liver_mapped_feat_wts.Rda"))[["outdegree"]]
load("/storage/kuijjerarea/romana/TCGAmofa/june_2024_run/outdeg_gep_tcga_common_tfs.Rda")

factors <- c("Factor2", "Factor3", "Factor4")
file_names <- paste0(rep("figures/liver_feat_wts_", length(factors)), factors, "_common.pdf")

plots <- Map(function(factor, file_name, ...) {
  plot_feat_wts(feat_wts = gep, fct = factor, file_name = file_name,
  thresh = NULL, plot_distribution = FALSE, manual_lab = common, n_feat = 0,
  width = 7, height = 10, limitsize = FALSE)
}, factors, file_names)

```

# randomising mofa seeds

```{r randomise_mofa_seed}
# set directory
seed_dir <- paste0(wd, "/seed_variations/")
setwd(seed_dir)

# set random seed
seeds <- sample.int(100, 5)

for (seed in seeds) {
  for (cancer in cancers) {
    load(paste0(wd, "/", cancer, "_omics_pca.Rda"))

    #nonet
    data_nonet <- omics[1:3]
    mofa_nonet <- run_mofa2(data_nonet, n_fct = 5, seed = seed, convergence = "slow", use_basilisk = T)
    save(mofa_nonet, file = paste0("MOFA_", cancer, "_pca_nonet_", seed, ".Rda"))

    # with both
    data_both <- omics
    mofa_both <- run_mofa2(data_both, n_fct = 5, seed = seed, convergence = "slow", use_basilisk = T)
    save(mofa_both, file = paste0("MOFA_", cancer, "_pca_both_", seed, ".Rda"))
  }
}

save(seeds, file = "random_seeds.Rda")
```

```{r surv_random_seed}
seed_dir <- paste0(wd, "/seed_variations/")
setwd(seed_dir)
load("random_seeds.Rda")

surv_seed <- data.frame()

for (seed in seeds) {
  surv_df <- data.frame()
  for (i in cancers) {
    # load mofa models
    nonet <- get(load(paste0("MOFA_", i, "_pca_nonet_", seed, ".Rda")))
    both <- get(load(paste0("MOFA_", i, "_pca_both_", seed, ".Rda")))

    # get surv data
    load(paste0(wd, "/", i, "_surv.Rda"))

    # getting factors
    nonet_fct <- get_factors(nonet)[[1]]
    both_fct <- get_factors(both)[[1]]

    cox <- surv_association(nonet_fct, surv, univariate = TRUE)
    cox_b <- surv_association(both_fct, surv, univariate = TRUE)

    df <- surv_compare(models = list(cox, cox_b),
                     model_labels = model[c(1, 4)], univariate = TRUE,
                     method = method)

    df$cancer <- i
    df$seed <- seed

    surv_df <- rbind(surv_df, df)

    cox_all <- list(cox, cox_b)
    names(cox_all) <- c("nonet", "both")

    save(cox_all, file = paste0(i,"_cox_models_PCA_quant_", seed, ".Rda"))
  }

  surv_seed <- rbind(surv_seed, surv_df)

  #save(surv_df, file = paste0("TCGA_MOFA_surv_df_all_PCA_quant_", seed, ".Rda"))
}

save(surv_seed, file = "TCGA_MOFA_surv_seed.Rda")
write.csv(surv_seed, file = "TCGA_MOFA_surv_seed.csv")
```

```{r samples_per_cancer}

for (cancer in cancers) {
  load(paste0(cancer, "_omics_no_pca.Rda"))
  load(paste0(cancer, "_surv.Rda"))
  print(cancer)
  samples <- .overlap_sets(list(surv$sample_id, colnames(omics[[1]])))
  print(length(samples))
}
```